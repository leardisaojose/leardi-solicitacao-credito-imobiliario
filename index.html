<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Solicitação de Crédito • Leardi São José Imóveis</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/dist/tailwind.min.css" rel="stylesheet" />
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
      const GS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwlxoAeAnaQm4ijge0HruzpuWNz39hZ4jdWtHm-uLOv4Wgtem3XJ_NhhHT_FFtyXOJ2/exec";
      const SETTINGS = { SUBMIT_TIMEOUT_MS: 12000, HEALTHCHECK_ON_LOAD: true };
      const BRAND = {
        name: "Leardi São José Imóveis",
        logo: "assets/logo.png",
      };

      function timeoutFetch(url, options = { timeout: SETTINGS.SUBMIT_TIMEOUT_MS }) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), options.timeout);
        const final = { ...options, signal: controller.signal };
        return fetch(url, final).finally(() => clearTimeout(id));
      }

      async function sendToSheets(json) {
        try {
          const res = await timeoutFetch(GS_WEB_APP_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(json),
            referrerPolicy: "no-referrer",
            timeout: SETTINGS.SUBMIT_TIMEOUT_MS,
          });
          if (res.ok || res.type === "opaque") return { ok: true, via: res.type === "opaque" ? "opaque" : "ok" };
        } catch(e1) { }
        try {
          await timeoutFetch(GS_WEB_APP_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify(json),
            referrerPolicy: "no-referrer",
            timeout: SETTINGS.SUBMIT_TIMEOUT_MS,
          });
          return { ok: true, via: "no-cors" };
        } catch(e2) {
          try {
            if (typeof navigator !== 'undefined' && typeof navigator.sendBeacon === 'function') {
              const blob = new Blob([JSON.stringify(json)], { type: 'text/plain;charset=utf-8' });
              const sent = navigator.sendBeacon(GS_WEB_APP_URL, blob);
              if (sent) return { ok: true, via: 'beacon' };
            }
          } catch(_){} 
          return { ok: false, error: e2?.message || String(e2) };
        }
      }

      function App() {
        const [msg, setMsg] = React.useState("");
        const [health, setHealth] = React.useState("");
        const [loading, setLoading] = React.useState(false);

<script type="text/babel">
  /* COLE estas funções de ping acima de testConnectivity() */
  function imgPing(url, timeout = 8000) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      let done = false;
      const finish = (ok) => { if (done) return; done = true; clearTimeout(t); img.onload = img.onerror = null; ok ? resolve(true) : reject(new Error("timeout")); };
      const t = setTimeout(() => finish(false), timeout);
      img.onload = () => finish(true);
      img.onerror = () => finish(true); // mesmo com CORS, prova reachability
      img.src = url + (url.includes("?") ? "&" : "?") + "imgping=" + Date.now();
    });
  }

  async function pingViaBeacon(url) {
    try {
      if (typeof navigator !== 'undefined' && typeof navigator.sendBeacon === 'function') {
        const blob = new Blob([JSON.stringify({ _probe: true, t: Date.now(), _meta: { from: 'ui-ping-beacon' } })], { type: 'text/plain;charset=utf-8' });
        const sent = navigator.sendBeacon(url, blob);
        if (sent) return true;
      }
    } catch {} 
    return false;
  }

  async function pingNoTimeout(url) {
    try {
      await fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ _probe: true, t: Date.now(), _meta: { from: 'ui-ping-nodelay' } }),
        referrerPolicy: 'no-referrer',
        // sem AbortController de propósito (evita AbortError)
      });
      return true;
    } catch {
      return false;
    }
  }

  /* SUBSTITUA sua testConnectivity() por esta */
  async function testConnectivity() {
    setHealth("Testando conexão com /exec ...");

    if (await pingViaBeacon(GS_WEB_APP_URL)) { setHealth("✅ Conectado (beacon)"); return; }
    if (await pingNoTimeout(GS_WEB_APP_URL)) { setHealth("✅ Conectado (POST no-cors)"); return; }

    try {
      await imgPing(GS_WEB_APP_URL, 8000);
      setHealth("✅ Conectado (imagem GET)");
      return;
    } catch {}

    setHealth("❌ Falhou: não foi possível alcançar a URL /exec a tempo. Abra a URL em aba anônima; se pedir login, reimplante como 'Qualquer pessoa com o link'.");
  }
</script>


        async function handleSubmit(e) {
          e.preventDefault();
          setMsg("");
          const json = { nome_1: e.target.nome_1?.value || "", cpf_1: e.target.cpf_1?.value || "", _meta: { sent_at: new Date().toISOString(), source: 'gh-pages-starter' } };
          setLoading(true);
          const result = await sendToSheets(json);
          if (result.ok) setMsg("✅ Enviado (" + result.via + ")"); else setMsg("❌ Falhou: " + (result.error || 'Erro desconhecido'));
          setLoading(false);
        }

        React.useEffect(() => testConnectivity(), []);

        return (
          <main className="max-w-2xl mx-auto p-6">
            <header className="flex items-center gap-3 mb-6">
              <img src={BRAND.logo} alt={BRAND.name} className="h-10 w-auto" />
              <div>
                <h1 className="text-xl font-semibold">Solicitação de Crédito Imobiliário</h1>
                <p className="text-sm text-slate-500">Preencha os dados para dar seguimento.</p>
              </div>
            </header>

            <section className="mb-4 p-4 rounded-xl border bg-slate-50 text-sm">
              <div className="mt-3 flex flex-wrap gap-2">
                <button type="button" onClick={testConnectivity} className="px-3 py-2 rounded bg-emerald-600 text-white">Testar conexão</button>
              </div>
              {health && <p className="mt-2 text-slate-700">{health}</p>}
            </section>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">Nome completo*</label>
                <input name="nome_1" placeholder="João da Silva" className="w-full rounded-xl border px-3 py-2" required />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">CPF*</label>
                <input name="cpf_1" placeholder="000.000.000-00" className="w-full rounded-xl border px-3 py-2" required />
              </div>
              <button type="submit" disabled={loading} className="rounded-2xl px-5 py-3 bg-sky-600 text-white font-medium disabled:opacity-60">{loading?"Enviando...":"Enviar solicitação"}</button>
              {msg && <p className="text-sm text-slate-700">{msg}</p>}
            </form>

            <footer className="text-sm text-slate-500 mt-10 pb-8">
              <p>© {new Date().getFullYear()} Leardi São José Imóveis</p>
            </footer>
          </main>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
